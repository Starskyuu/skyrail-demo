<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>校园空中交通 · 监控与预约</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: rgba(15, 22, 32, 0.72);
      --panel2: rgba(12, 18, 26, 0.70);
      --text: #e6edf3;
      --muted: #94a3b8;
      --line: #1f2a37;
      --track: #33547a;
      --trackInner: #0b1a2a;
      --accent: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --btnA: #1b2636;
      --btnB: #0f1a29;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    [data-theme="light"] {
      --bg: #f6f7fb;
      --panel: rgba(255, 255, 255, 0.82);
      --panel2: rgba(255, 255, 255, 0.72);
      --text: #0b1220;
      --muted: #475569;
      --line: #d7dde7;
      --track: #8bb4ff;
      --trackInner: #dbeafe;
      --accent: #2563eb;
      --btnA: #ffffff;
      --btnB: #f3f5fb;
      --shadow: 0 12px 28px rgba(15, 23, 42, 0.10);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(18, 32, 51, 0.28) 0%, var(--bg) 60%);
      color: var(--text);
    }
    [data-theme="light"] body {
      background: radial-gradient(1200px 700px at 30% -10%, rgba(37, 99, 235, 0.10) 0%, var(--bg) 60%);
    }

    button, select, input {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--btnA), var(--btnB));
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
    }
    button { cursor: pointer; }
    button:hover { border-color: color-mix(in oklab, var(--line) 40%, var(--accent)); }
    input::placeholder { color: color-mix(in oklab, var(--muted) 75%, transparent); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: var(--panel2);
      font-size: 12px;
      color: var(--muted);
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok); display: inline-block; }
    .dot.off { background: var(--bad); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .panel .hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--line);
    }
    .panel .hd h2 { font-size: 13px; margin: 0; font-weight: 650; color: color-mix(in oklab, var(--text) 85%, var(--accent)); }
    .panel .bd { padding: 12px; }

    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel2);
      padding: 10px;
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .k { color: var(--muted); font-size: 12px; }
    .v { font-size: 12px; }

    .status {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 8px; border-radius: 999px; font-size: 12px;
      border: 1px solid var(--line); background: var(--panel);
    }
    .status .sDot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok); }
    .status.warn .sDot { background: var(--warn); }
    .status.bad .sDot { background: var(--bad); }

    .log {
      max-height: 360px;
      overflow: auto;
      display: grid;
      gap: 8px;
      padding-right: 6px;
    }
    .logItem {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: color-mix(in oklab, var(--panel2) 85%, transparent);
      display: grid;
      gap: 4px;
    }
    .logItem .t { font-size: 12px; color: color-mix(in oklab, var(--text) 80%, var(--accent)); }
    .logItem .m { font-size: 12px; color: var(--muted); line-height: 1.35; }
    .logItem .ts { font-size: 11px; color: color-mix(in oklab, var(--muted) 65%, transparent); }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
    }

    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .title { display: flex; flex-direction: column; gap: 2px; }
    .title h1 { font-size: 16px; margin: 0; font-weight: 650; }
    .title .sub { font-size: 12px; color: var(--muted); }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tabs {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel2);
      box-shadow: var(--shadow);
    }
    .tabsLeft, .tabsRight { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .tabBtn {
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: color-mix(in oklab, var(--panel) 80%, transparent);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }
    .tabBtn.active {
      border-color: color-mix(in oklab, var(--accent) 65%, var(--line));
      background: color-mix(in oklab, var(--accent) 12%, var(--panel));
    }

    .mapWrap {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 10;
      background: var(--panel2);
      border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--line) 75%, transparent);
      overflow: hidden;
    }
    .mapWrap svg { width: 100%; height: 100%; display: block; }

    .legend {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 8px;
      align-items: start;
      pointer-events: none;
    }
    .tag {
      font-size: 12px;
      line-height: 1.25;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 8px;
      background: var(--panel);
      pointer-events: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tag strong { color: var(--text); font-weight: 650; }

    .belt { filter: drop-shadow(0 6px 12px rgba(0,0,0,0.25)); }
    .belt rect.track { fill: color-mix(in oklab, var(--panel) 85%, transparent); stroke: color-mix(in oklab, var(--line) 60%, transparent); stroke-width: 2; }
    .belt rect.top { fill: color-mix(in oklab, var(--accent) 20%, transparent); }
    .belt circle.seat { fill: color-mix(in oklab, var(--text) 80%, transparent); opacity: 0.9; }
    .belt circle.core { fill: var(--bg); opacity: 0.9; }

    /* 摄像头区域：实时摄像头流 */
    .camGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .camView {
      aspect-ratio: 16 / 10;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #000;
      overflow: hidden;
      position: relative;
      box-shadow: var(--shadow);
    }
    .camView video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    .camHud {
      position: absolute; inset: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
    }
    .camHud .top {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px;
    }
    .camHud .label {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--line) 75%, transparent);
      background: color-mix(in oklab, var(--panel) 85%, transparent);
      font-size: 12px;
      color: var(--text);
    }
    .camHud .meta {
      font-size: 12px;
      color: var(--muted);
      display: inline-flex;
      gap: 10px;
      align-items: center;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--line) 75%, transparent);
      background: color-mix(in oklab, var(--panel) 75%, transparent);
    }
    .camBadge {
      position:absolute;
      left:10px;
      bottom:10px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid color-mix(in oklab, var(--line) 75%, transparent);
      background: color-mix(in oklab, var(--panel) 80%, transparent);
      font-size:12px;
      color: var(--text);
      pointer-events:none;
    }
    .camErr {
      position:absolute;
      inset:0;
      display:none;
      place-items:center;
      padding:14px;
      text-align:center;
      color: color-mix(in oklab, var(--text) 85%, var(--bad));
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75));
    }
    .camErr .box{
      max-width: 560px;
      border:1px solid color-mix(in oklab, var(--bad) 45%, var(--line));
      border-radius: 14px;
      padding: 12px;
      background: color-mix(in oklab, var(--panel) 60%, transparent);
    }
    .camErr .box .t{ font-weight:650; margin-bottom:6px; }
    .camErr .box .m{ font-size:12px; color: color-mix(in oklab, var(--text) 80%, var(--muted)); line-height:1.4; }
    .camErr .box .actions{ margin-top:10px; display:flex; gap:8px; justify-content:center; pointer-events:auto; }

    /* Modal */
    .modalBackdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 50;
    }
    [data-theme="light"] .modalBackdrop { background: rgba(2, 6, 23, 0.35); }
    .modal {
      width: min(600px, 100%);
      border-radius: 16px;
      border: 1px solid var(--line);
      background: color-mix(in oklab, var(--panel) 95%, transparent);
      backdrop-filter: blur(12px);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .modal .mh {
      padding: 12px 12px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--line);
    }
    .modal .mh h3 { margin: 0; font-size: 14px; font-weight: 650; }
    .modal .mb { padding: 12px; display: grid; gap: 10px; }
    .modal label { font-size: 12px; color: var(--muted); display: grid; gap: 6px; }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; padding: 12px; border-top: 1px solid var(--line); }
    .primary { border-color: color-mix(in oklab, var(--accent) 55%, var(--line)); }
    .primary:hover { border-color: color-mix(in oklab, var(--accent) 85%, var(--line)); }
    .ghost { background: color-mix(in oklab, var(--panel2) 75%, transparent); }
    .hint { font-size: 12px; color: var(--muted); line-height: 1.35; }
    .twoCol { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Login */
    .loginWrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .loginCard {
      width: min(420px, 100%);
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .loginCard h1 { margin: 0 0 6px; font-size: 16px; font-weight: 650; }
    .loginCard .sub { margin: 0 0 12px; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .loginCard .grid { display: grid; gap: 10px; }
    .loginCard .err {
      display: none;
      border: 1px solid color-mix(in oklab, var(--bad) 55%, var(--line));
      background: color-mix(in oklab, var(--bad) 10%, var(--panel));
      color: color-mix(in oklab, var(--text) 85%, var(--bad));
      border-radius: 12px;
      padding: 10px;
      font-size: 12px;
      line-height: 1.35;
    }
    .loginCard .row2 { display:flex; gap:8px; justify-content: space-between; align-items: center; }
    .loginCard .mini { font-size: 12px; color: var(--muted); }
    .loginCard .actions { display:flex; gap:8px; justify-content: flex-end; margin-top: 2px; }
    .hide { display: none !important; }

    /* Seat modal */
    .seatGrid { display:grid; gap:10px; }
    .seatItem {
      border: 1px solid var(--line);
      background: var(--panel2);
      border-radius: 12px;
      padding: 10px;
      display:grid;
      gap:6px;
    }
    .seatBar {
      height: 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--line) 75%, transparent);
      background: color-mix(in oklab, var(--panel) 55%, transparent);
      overflow:hidden;
    }
    .seatFill {
      height: 100%;
      width: 0%;
      background: color-mix(in oklab, var(--accent) 45%, transparent);
    }

    /* Music modal */
    .songList { display:grid; gap:8px; }
    .songRow {
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      border: 1px solid var(--line);
      background: var(--panel2);
      border-radius: 12px;
      padding: 10px;
    }
    .songMeta { display:grid; gap:2px; }
    .songTitle { font-weight:650; font-size:13px; }
    .songSub { font-size:12px; color: var(--muted); }
    .songActions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .miniBtn { padding: 7px 9px; font-size: 12px; border-radius: 10px; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .camGrid { grid-template-columns: 1fr; }
      .tag { white-space: normal; border-radius: 14px; }
      .legend { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- 登录界面 -->
  <section id="loginScreen" class="loginWrap">
    <div class="loginCard">
      <div class="row" style="margin-bottom: 6px;">
        <div>
          <h1>校园空中交通 · 控制台</h1>
          <div class="sub">登录后进入实时监控、座位预约与 7 路视频监控调看（浏览器实时摄像头）。</div>
        </div>
        <button id="btnThemeLogin" class="ghost">浅色模式</button>
      </div>

      <div id="loginErr" class="err"></div>

      <div class="grid">
        <label>用户名
          <input id="loginUser" type="text" placeholder="例如：admin" autocomplete="username" />
        </label>
        <label>密码
          <input id="loginPass" type="password" placeholder="例如：123456" autocomplete="current-password" />
        </label>

        <div class="row2">
          <span class="mini">演示账号：admin / 123456</span>
          <div class="actions">
            <button id="btnLogin" class="primary">进入系统</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 主应用 -->
  <main id="appRoot" class="hide">
    <div class="app">
      <header>
        <div class="title">
          <h1>校园空中交通 · 实时监控与座位预约</h1>
          <div class="sub">交通载具：大型传送带 + 座位｜站点：宿舍总站 & 第一~第六教学楼 + C楼｜监控：7 路（实时摄像头）</div>
        </div>
        <div class="toolbar">
          <span class="pill"><span id="connDot" class="dot"></span><span id="connText">在线（仿真）</span></span>
          <button id="btnTheme" class="ghost">浅色模式</button>
          <button id="btnLogout" class="ghost">退出</button>
        </div>
      </header>

      <nav class="tabs">
        <div class="tabsLeft">
          <button class="tabBtn active" data-tab="ops">交通态势</button>
          <button class="tabBtn" data-tab="cams">监控调看</button>
        </div>
        <div class="tabsRight">
          <button id="btnReserve" class="primary">座位预约</button>
          <button id="btnSeatStatus" class="ghost">座位情况</button>
          <button id="btnSong" class="ghost">点歌</button>
          <button id="btnPause" class="ghost">暂停仿真</button>
          <button id="btnViewLog" class="ghost">事件日志</button>
        </div>
      </nav>

      <!-- 交通态势 -->
      <section id="tabPanelOps" class="panel" style="grid-column: 1 / -1;">
        <div class="hd">
          <h2>轨道与载具位置（主环线 + 支线）</h2>
          <div class="k">刷新周期：<span id="tickMs">500</span> ms｜剩余座位实时更新</div>
        </div>
        <div class="bd" style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 12px;">
          <div class="panel" style="box-shadow:none;">
            <div class="bd">
              <div class="mapWrap">
                <svg viewBox="0 0 1000 625" aria-label="轨道地图">
                  <!-- 主环线 -->
                  <path id="trackMain"
                    d="M 180 450
                       C 140 310, 220 180, 370 180
                       C 470 180, 520 120, 650 140
                       C 820 170, 880 320, 810 430
                       C 760 510, 640 540, 520 520
                       C 450 505, 380 560, 290 530
                       C 220 510, 195 500, 180 450"
                    fill="none" stroke="var(--track)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
                  <path
                    d="M 180 450
                       C 140 310, 220 180, 370 180
                       C 470 180, 520 120, 650 140
                       C 820 170, 880 320, 810 430
                       C 760 510, 640 540, 520 520
                       C 450 505, 380 560, 290 530
                       C 220 510, 195 500, 180 450"
                    fill="none" stroke="var(--trackInner)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>

                  <!-- 支线：T2 ↔ T6 -->
                  <path id="trackBranch"
                    d="M 395 205
                       C 315 140, 285 105, 235 95
                       C 180 85, 135 120, 120 165
                       C 105 215, 125 260, 175 275
                       C 235 295, 310 265, 360 235"
                    fill="none" stroke="var(--track)" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" opacity="0.85"/>
                  <path
                    d="M 395 205
                       C 315 140, 285 105, 235 95
                       C 180 85, 135 120, 120 165
                       C 105 215, 125 260, 175 275
                       C 235 295, 310 265, 360 235"
                    fill="none" stroke="var(--trackInner)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.85"/>

                  <!-- 站点（由 JS 计算并渲染，确保在轨道线上） -->
                  <g id="stations"></g>

                  <!-- 载具（四辆） -->
                  <g id="belt1" class="belt">
                    <rect class="track" x="-28" y="-14" width="56" height="28" rx="10"></rect>
                    <rect class="top" x="-22" y="-9" width="44" height="18" rx="8"></rect>
                    <circle class="seat" cx="-12" cy="0" r="4"></circle>
                    <circle class="seat" cx="0" cy="0" r="4"></circle>
                    <circle class="seat" cx="12" cy="0" r="4"></circle>
                    <circle class="core" cx="0" cy="0" r="2"></circle>
                  </g>
                  <g id="belt2" class="belt">
                    <rect class="track" x="-28" y="-14" width="56" height="28" rx="10"></rect>
                    <rect class="top" x="-22" y="-9" width="44" height="18" rx="8"></rect>
                    <circle class="seat" cx="-12" cy="0" r="4"></circle>
                    <circle class="seat" cx="0" cy="0" r="4"></circle>
                    <circle class="seat" cx="12" cy="0" r="4"></circle>
                    <circle class="core" cx="0" cy="0" r="2"></circle>
                  </g>
                  <g id="belt3" class="belt">
                    <rect class="track" x="-28" y="-14" width="56" height="28" rx="10"></rect>
                    <rect class="top" x="-22" y="-9" width="44" height="18" rx="8"></rect>
                    <circle class="seat" cx="-12" cy="0" r="4"></circle>
                    <circle class="seat" cx="0" cy="0" r="4"></circle>
                    <circle class="seat" cx="12" cy="0" r="4"></circle>
                    <circle class="core" cx="0" cy="0" r="2"></circle>
                  </g>
                  <g id="belt4" class="belt">
                    <rect class="track" x="-28" y="-14" width="56" height="28" rx="10"></rect>
                    <rect class="top" x="-22" y="-9" width="44" height="18" rx="8"></rect>
                    <circle class="seat" cx="-12" cy="0" r="4"></circle>
                    <circle class="seat" cx="0" cy="0" r="4"></circle>
                    <circle class="seat" cx="12" cy="0" r="4"></circle>
                    <circle class="core" cx="0" cy="0" r="2"></circle>
                  </g>

                  <line id="vec1" x1="0" y1="0" x2="0" y2="0"
                        stroke="color-mix(in oklab, var(--accent) 70%, white)" stroke-width="3" opacity="0.9" />
                  <line id="vec2" x1="0" y1="0" x2="0" y2="0"
                        stroke="color-mix(in oklab, var(--ok) 70%, white)" stroke-width="3" opacity="0.9" />
                  <line id="vec3" x1="0" y1="0" x2="0" y2="0"
                        stroke="color-mix(in oklab, var(--warn) 70%, white)" stroke-width="3" opacity="0.9" />
                  <line id="vec4" x1="0" y1="0" x2="0" y2="0"
                        stroke="color-mix(in oklab, var(--text) 70%, var(--accent))" stroke-width="3" opacity="0.9" />
                </svg>

                <div class="legend">
                  <div class="tag"><strong>载具</strong> 传送带-01（主环线/可分流支线）</div>
                  <div class="tag"><strong>载具</strong> 传送带-02（主环线/可分流支线）</div>
                  <div class="tag"><strong>载具</strong> 传送带-03（主环线/可分流支线）</div>
                  <div class="tag"><strong>载具</strong> 传送带-04（主环线/可分流支线）</div>
                  <div class="tag">支线：T2 ↔ T6</div>
                </div>
              </div>
            </div>
          </div>

          <aside style="display:grid; gap:10px;">
            <div class="card">
              <div class="row">
                <div>
                  <div style="font-weight:650;">传送带-01</div>
                  <div class="k">下一站：<span id="b1Next">—</span></div>
                </div>
                <span class="status" id="b1Status"><span class="sDot"></span><span id="b1StatusText">运行中</span></span>
              </div>
              <div style="height:8px;"></div>
              <div class="row"><div class="k">速度</div><div class="v"><span id="b1Speed">—</span> m/s</div></div>
              <div class="row"><div class="k">载客</div><div class="v"><span id="b1Pax">—</span> / <span id="b1Cap">—</span></div></div>
              <div class="row"><div class="k">剩余座位</div><div class="v"><span id="b1Seats">—</span></div></div>
              <div class="row"><div class="k">延误</div><div class="v"><span id="b1Delay">—</span> s</div></div>
            </div>

            <div class="card">
              <div class="row">
                <div>
                  <div style="font-weight:650;">传送带-02</div>
                  <div class="k">下一站：<span id="b2Next">—</span></div>
                </div>
                <span class="status" id="b2Status"><span class="sDot"></span><span id="b2StatusText">运行中</span></span>
              </div>
              <div style="height:8px;"></div>
              <div class="row"><div class="k">速度</div><div class="v"><span id="b2Speed">—</span> m/s</div></div>
              <div class="row"><div class="k">载客</div><div class="v"><span id="b2Pax">—</span> / <span id="b2Cap">—</span></div></div>
              <div class="row"><div class="k">剩余座位</div><div class="v"><span id="b2Seats">—</span></div></div>
              <div class="row"><div class="k">延误</div><div class="v"><span id="b2Delay">—</span> s</div></div>
            </div>

            <div class="card">
              <div class="row">
                <div>
                  <div style="font-weight:650;">传送带-03</div>
                  <div class="k">下一站：<span id="b3Next">—</span></div>
                </div>
                <span class="status" id="b3Status"><span class="sDot"></span><span id="b3StatusText">运行中</span></span>
              </div>
              <div style="height:8px;"></div>
              <div class="row"><div class="k">速度</div><div class="v"><span id="b3Speed">—</span> m/s</div></div>
              <div class="row"><div class="k">载客</div><div class="v"><span id="b3Pax">—</span> / <span id="b3Cap">—</span></div></div>
              <div class="row"><div class="k">剩余座位</div><div class="v"><span id="b3Seats">—</span></div></div>
              <div class="row"><div class="k">延误</div><div class="v"><span id="b3Delay">—</span> s</div></div>
            </div>

            <div class="card">
              <div class="row">
                <div>
                  <div style="font-weight:650;">传送带-04</div>
                  <div class="k">下一站：<span id="b4Next">—</span></div>
                </div>
                <span class="status" id="b4Status"><span class="sDot"></span><span id="b4StatusText">运行中</span></span>
              </div>
              <div style="height:8px;"></div>
              <div class="row"><div class="k">速度</div><div class="v"><span id="b4Speed">—</span> m/s</div></div>
              <div class="row"><div class="k">载客</div><div class="v"><span id="b4Pax">—</span> / <span id="b4Cap">—</span></div></div>
              <div class="row"><div class="k">剩余座位</div><div class="v"><span id="b4Seats">—</span></div></div>
              <div class="row"><div class="k">延误</div><div class="v"><span id="b4Delay">—</span> s</div></div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:650;">线路健康</div>
                <span class="status" id="lineStatus"><span class="sDot"></span><span id="lineStatusText">良好</span></span>
              </div>
              <div style="height:8px;"></div>
              <div class="row"><div class="k">主环线</div><div class="v">S → T1 → T2 → T3 → C → T4 → T5 → S</div></div>
              <div class="row"><div class="k">支线</div><div class="v">T2 ↔ T6</div></div>
              <div class="row"><div class="k">告警</div><div class="v" id="alarms">0</div></div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:650;">站点到站倒计时</div>
                <div class="k">下一班车（最短 ETA）</div>
              </div>
              <div style="height:8px;"></div>
              <div id="etaList" style="display:grid; gap:6px;">
                <div class="row"><div class="k">S 宿舍总站</div><div class="v"><span id="eta_S">—</span></div></div>
                <div class="row"><div class="k">T1 第一教学楼</div><div class="v"><span id="eta_T1">—</span></div></div>
                <div class="row"><div class="k">T2 第二教学楼</div><div class="v"><span id="eta_T2">—</span></div></div>
                <div class="row"><div class="k">T3 第三教学楼</div><div class="v"><span id="eta_T3">—</span></div></div>
                <div class="row"><div class="k">C C楼</div><div class="v"><span id="eta_C">—</span></div></div>
                <div class="row"><div class="k">T4 第四教学楼</div><div class="v"><span id="eta_T4">—</span></div></div>
                <div class="row"><div class="k">T5 第五教学楼</div><div class="v"><span id="eta_T5">—</span></div></div>
                <div class="row"><div class="k">T6 第六教学楼</div><div class="v"><span id="eta_T6">—</span></div></div>
              </div>
              <div style="height:8px;"></div>
              <div class="hint">ETA 为演示估计：取所有载具到达该站点的最短时间。</div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:650;">事件日志</div>
                <div class="k">点击上方按钮弹窗查看</div>
              </div>
              <div style="height:10px;"></div>
              <div class="hint">保留最近 30 条；支持滚动查看；仍在后台持续记录。</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- 监控调看 -->
      <section id="tabPanelCams" class="panel hide" style="grid-column: 1 / -1;">
        <div class="hd">
          <h2>监控调看（7 路逻辑通道 · 实时摄像头）</h2>
          <div class="k" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <span>通道：</span><select id="camSelect"></select>
            <span>设备：</span><select id="camDeviceSelect"></select>
            <button id="btnCamStart" class="primary">开启摄像头</button>
          </div>
        </div>
        <div class="bd">
          <div class="camGrid">
            <div class="camView">
              <video id="camVideo" autoplay muted playsinline></video>

              <div class="camErr" id="camErr">
                <div class="box">
                  <div class="t">无法打开摄像头</div>
                  <div class="m" id="camErrMsg">请在浏览器地址栏允许摄像头权限；或更换设备后重试。</div>
                  <div class="actions">
                    <button id="btnCamRetry" class="primary">重试</button>
                    <button id="btnCamStop" class="ghost">停止</button>
                  </div>
                </div>
              </div>

              <div class="camHud">
                <div class="top">
                  <div class="label">
                    <span class="dot" id="camDot"></span>
                    <span id="camTitle">CAM-01</span>
                  </div>
                  <div class="meta">
                    <span id="camWhere">—</span>
                    <span>FPS: <span id="camFps">—</span></span>
                    <span>延迟: <span id="camLag">—</span> ms</span>
                  </div>
                </div>
                <div class="meta" style="align-self:flex-end;">
                  <span>时间：<span id="camTime">—</span></span>
                </div>
              </div>
              <div class="camBadge" id="camSrcBadge">源：WebCamera</div>
            </div>

            <div class="card">
              <div style="font-weight:650; margin-bottom:8px;">监控状态</div>
              <div class="row"><div class="k">当前通道</div><div class="v" id="camChan">—</div></div>
              <div class="row"><div class="k">位置</div><div class="v" id="camPos">—</div></div>
              <div class="row"><div class="k">设备</div><div class="v" id="camDev">—</div></div>
              <div class="row"><div class="k">异常检测</div><div class="v" id="camAI">—</div></div>
              <div style="height:10px;"></div>
              <div class="hint">
                说明：7 路为“逻辑通道”（站点/区段），实际视频来自浏览器摄像头设备；若电脑有多摄像头，可在“设备”中切换。
              </div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
              <div style="font-weight:650; margin-bottom:8px;">7 路监控列表（逻辑通道）</div>
              <div id="camList" style="display:grid; gap:8px;"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 座位预约弹窗 -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="座位预约窗口">
    <div class="modal">
      <div class="mh">
        <h3>座位预约</h3>
        <button id="btnClose" class="ghost">关闭</button>
      </div>
      <div class="mb">
        <div class="hint">
          演示逻辑：提交预约后，会优先在“剩余座位足够”的传送带上预留座位，并在下一次到站时确认上客；若涉及第六教学楼（T6），将于第二教学楼（T2）分流进入支线。
        </div>
        <div class="twoCol">
          <label>上车站点
            <select id="fromStation"></select>
          </label>
          <label>目的站点
            <select id="toStation"></select>
          </label>
        </div>
        <div class="twoCol">
          <label>预约座位数
            <input id="seatsNeed" type="number" min="1" max="20" value="1" />
          </label>
          <label>优先级
            <select id="priority">
              <option value="normal">普通</option>
              <option value="high">高（赶课/换乘）</option>
              <option value="access">无障碍</option>
            </select>
          </label>
        </div>
        <label>备注（可选）
          <input id="note" type="text" placeholder="例如：无障碍/携带大件物品" />
        </label>
      </div>
      <div class="actions">
        <button id="btnSubmit" class="primary">提交预约</button>
        <button id="btnCancel" class="ghost">取消</button>
      </div>
    </div>
  </div>

  <!-- 事件日志弹窗 -->
  <div class="modalBackdrop" id="logModalBackdrop" role="dialog" aria-modal="true" aria-label="事件日志窗口">
    <div class="modal" style="width:min(760px,100%);">
      <div class="mh">
        <h3>事件日志</h3>
        <button id="btnLogClose" class="ghost">关闭</button>
      </div>
      <div class="mb">
        <div class="hint">保留最近 30 条（最新在最上方）。</div>
        <div class="log" id="log"></div>
      </div>
      <div class="actions">
        <button id="btnLogClose2" class="primary">关闭</button>
      </div>
    </div>
  </div>

  <!-- 座位情况弹窗 -->
  <div class="modalBackdrop" id="seatModalBackdrop" role="dialog" aria-modal="true" aria-label="座位情况窗口">
    <div class="modal" style="width:min(760px,100%);">
      <div class="mh">
        <h3>座位情况</h3>
        <button id="btnSeatClose" class="ghost">关闭</button>
      </div>
      <div class="mb">
        <div class="hint">按传送带汇总：载客、容量、剩余座位、占用率（实时刷新）。</div>
        <div class="seatGrid" id="seatGrid"></div>
      </div>
      <div class="actions">
        <button id="btnSeatClose2" class="primary">关闭</button>
      </div>
    </div>
  </div>

  <!-- 点歌弹窗 -->
  <div class="modalBackdrop" id="songModalBackdrop" role="dialog" aria-modal="true" aria-label="点歌窗口">
    <div class="modal" style="width:min(760px,100%);">
      <div class="mh">
        <h3>点歌</h3>
        <button id="btnSongClose" class="ghost">关闭</button>
      </div>
      <div class="mb">
        <div class="hint">
          说明：此处提供“已有歌曲列表”。默认使用同目录音频文件（song01.mp3 等）。如未放置文件，将提示无法播放。
        </div>

        <div class="card">
          <div class="row">
            <div>
              <div style="font-weight:650;">正在播放</div>
              <div class="k" id="nowPlaying">—</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
              <button id="btnMusicStop" class="ghost miniBtn">停止</button>
              <label style="display:flex; gap:8px; align-items:center; margin:0; color:var(--muted); font-size:12px;">
                音量
                <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.8" style="padding:0; height:12px;">
              </label>
            </div>
          </div>
          <div style="height:8px;"></div>
          <audio id="musicAudio" controls style="width:100%;"></audio>
          <div class="hint" id="musicErr" style="display:none; margin-top:8px; color: color-mix(in oklab, var(--text) 85%, var(--bad));"></div>
        </div>

        <div class="songList" id="songList"></div>
      </div>
      <div class="actions">
        <button id="btnSongClose2" class="primary">关闭</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== 主题 ===== */
    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      const text = (theme === "dark") ? "浅色模式" : "深色模式";
      const btnA = document.getElementById("btnTheme");
      const btnB = document.getElementById("btnThemeLogin");
      if (btnA) btnA.textContent = text;
      if (btnB) btnB.textContent = text;
      try { localStorage.setItem("skyrail_theme", theme); } catch {}
    }
    function toggleTheme() {
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(cur === "dark" ? "light" : "dark");
    }

    /* ===== 登录（演示） ===== */
    const LOGIN_USER = "admin";
    const LOGIN_PASS = "123456";
    const loginScreen = document.getElementById("loginScreen");
    const appRoot = document.getElementById("appRoot");
    const loginErr = document.getElementById("loginErr");

    function showLoginError(msg){ loginErr.style.display="block"; loginErr.textContent=msg; }
    function clearLoginError(){ loginErr.style.display="none"; loginErr.textContent=""; }
    function setLoggedIn(on){
      if (on){ loginScreen.classList.add("hide"); appRoot.classList.remove("hide"); }
      else { appRoot.classList.add("hide"); loginScreen.classList.remove("hide"); }
    }

    document.getElementById("btnThemeLogin").addEventListener("click", toggleTheme);
    document.getElementById("btnLogin").addEventListener("click", ()=>{
      const u = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value;
      clearLoginError();
      if (!u || !p) return showLoginError("请输入用户名与密码。");
      if (u === LOGIN_USER && p === LOGIN_PASS) {
        setLoggedIn(true);
        addLog("登录", `用户 ${u} 已进入系统`);
      } else {
        showLoginError("用户名或密码错误（演示账号：admin / 123456）。");
      }
    });
    document.getElementById("loginPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") document.getElementById("btnLogin").click(); });
    document.getElementById("loginUser").addEventListener("keydown", (e)=>{ if(e.key==="Enter") document.getElementById("btnLogin").click(); });

    /* ===== 数据：站点/线路（含 C楼） ===== */
    const stations = [
      { id:"S",  name:"宿舍总站", line:"main" },
      { id:"T1", name:"第一教学楼", line:"main" },
      { id:"T2", name:"第二教学楼", line:"main" },
      { id:"T3", name:"第三教学楼", line:"main" },
      { id:"C",  name:"C楼",     line:"main" },
      { id:"T4", name:"第四教学楼", line:"main" },
      { id:"T5", name:"第五教学楼", line:"main" },
      { id:"T6", name:"第六教学楼", line:"branch" },
    ];

    const mainLoopOrder = ["S","T1","T2","T3","C","T4","T5"];
    let mainMarks = { S:0.10, T1:0.20, T2:0.30, T3:0.42, C:0.52, T4:0.60, T5:0.74 };
    let branchMarks = { T2:0.00, T6:1.00 };

    const state = {
      connected:true,
      paused:false,
      tickMs:500,
      alarms:0,
      reservations:[],
      belts:{
        B1:{ id:"传送带-01", mode:"main", t:0.14, u:0.00, vMain:0.020, vBranch:0.020, cap:48, pax:18, delay:0, status:"ok", next:"T1" },
        B2:{ id:"传送带-02", mode:"main", t:0.64, u:0.00, vMain:0.017, vBranch:0.018, cap:64, pax:31, delay:0, status:"ok", next:"T5" },
        B3:{ id:"传送带-03", mode:"main", t:0.34, u:0.00, vMain:0.019, vBranch:0.019, cap:56, pax:22, delay:0, status:"ok", next:"T3" },
        B4:{ id:"传送带-04", mode:"main", t:0.86, u:0.00, vMain:0.016, vBranch:0.017, cap:52, pax:27, delay:0, status:"ok", next:"T1" },
      }
    };

    /* ===== SVG 路径 ===== */
    const trackMain = document.getElementById("trackMain");
    const trackBranch = document.getElementById("trackBranch");
    const lenMain = trackMain.getTotalLength();
    const lenBranch = trackBranch.getTotalLength();

    function clamp(x,lo,hi){ return Math.max(lo, Math.min(hi,x)); }
    function rand(a,b){ return a + Math.random()*(b-a); }

    function pointOnMain(t){
      const p = trackMain.getPointAtLength((t%1)*lenMain);
      return {x:p.x,y:p.y};
    }
    function tangentOnMain(t){
      const eps=0.002;
      const p1=pointOnMain(Math.max(0,t-eps));
      const p2=pointOnMain(Math.min(1,t+eps));
      const dx=p2.x-p1.x, dy=p2.y-p1.y;
      const mag=Math.max(1e-6, Math.hypot(dx,dy));
      return {x:dx/mag,y:dy/mag};
    }
    function pointOnBranch(u){
      const p = trackBranch.getPointAtLength(clamp(u,0,1)*lenBranch);
      return {x:p.x,y:p.y};
    }
    function tangentOnBranch(u){
      const eps=0.004;
      const p1=pointOnBranch(Math.max(0,u-eps));
      const p2=pointOnBranch(Math.min(1,u+eps));
      const dx=p2.x-p1.x, dy=p2.y-p1.y;
      const mag=Math.max(1e-6, Math.hypot(dx,dy));
      return {x:dx/mag,y:dy/mag};
    }

    function stationLabel(id){
      const s=stations.find(x=>x.id===id);
      return s?`${s.id} ${s.name}`:id;
    }
    function nextInMainLoop(id){
      const idx=mainLoopOrder.indexOf(id);
      return idx===-1?"S":mainLoopOrder[(idx+1)%mainLoopOrder.length];
    }
    function nearestMainStationId(t){
      let best="S", bestD=Infinity;
      for (const [id,mt] of Object.entries(mainMarks)){
        const d=Math.min(Math.abs(t-mt), 1-Math.abs(t-mt));
        if(d<bestD){bestD=d;best=id;}
      }
      return best;
    }
    function isNearMainStation(t,id,thr=0.014){
      const mt=mainMarks[id];
      const d=Math.min(Math.abs(t-mt), 1-Math.abs(t-mt));
      return d<thr;
    }
    function isNearBranchStation(u,id,thr=0.035){
      const mu=branchMarks[id];
      return Math.abs(u-mu)<thr;
    }
    function priorityLabel(p){
      return p==="high"?"高":(p==="access"?"无障碍":"普通");
    }

    /* ===== UI 快捷引用 & 日志 ===== */
    const el = (id)=>document.getElementById(id);
    const connDot = el("connDot");
    const connText = el("connText");
    const btnPause = el("btnPause");
    const btnTheme = el("btnTheme");
    const btnLogout = el("btnLogout");

    const belt1 = el("belt1");
    const belt2 = el("belt2");
    const belt3 = el("belt3");
    const belt4 = el("belt4");
    const vec1 = el("vec1");
    const vec2 = el("vec2");
    const vec3 = el("vec3");
    const vec4 = el("vec4");

    const logEl = el("log");

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function addLog(title,msg){
      const now=new Date();
      const item=document.createElement("div");
      item.className="logItem";
      item.innerHTML=`
        <div class="t">${escapeHtml(title)}</div>
        <div class="m">${escapeHtml(msg)}</div>
        <div class="ts">${now.toLocaleString()}</div>
      `;
      logEl.prepend(item);
      while(logEl.children.length>30) logEl.removeChild(logEl.lastChild);
    }

    /* ===== 站点“贴合轨道”：根据期望位置在路径上求最近点，并渲染站点 ===== */
    function nearestParamOnPath(pathEl, len, target, samples=1400){
      let bestT=0, bestD=Infinity;
      for(let i=0;i<=samples;i++){
        const t=i/samples;
        const p=pathEl.getPointAtLength(t*len);
        const dx=p.x-target.x, dy=p.y-target.y;
        const d=dx*dx+dy*dy;
        if(d<bestD){ bestD=d; bestT=t; }
      }
      return bestT;
    }

    const desiredMainPos = {
      S:  {x:205,y:430},
      T1: {x:320,y:520},
      T2: {x:395,y:205},
      T3: {x:540,y:150},
      C:  {x:660,y:180},
      T4: {x:785,y:300},
      T5: {x:620,y:520},
    };
    const desiredBranchPos = {
      T2: {x:395,y:205},
      T6: {x:155,y:165},
    };

    function computeMarksAndRenderStations(){
      const newMainMarks = {};
      for (const id of Object.keys(desiredMainPos)){
        newMainMarks[id] = nearestParamOnPath(trackMain, lenMain, desiredMainPos[id]);
      }
      mainMarks = newMainMarks;

      const newBranchMarks = {};
      newBranchMarks.T2 = nearestParamOnPath(trackBranch, lenBranch, desiredBranchPos.T2);
      newBranchMarks.T6 = nearestParamOnPath(trackBranch, lenBranch, desiredBranchPos.T6);
      newBranchMarks.T2 = clamp(newBranchMarks.T2, 0.00, 0.12);
      newBranchMarks.T6 = clamp(newBranchMarks.T6, 0.88, 1.00);
      branchMarks = newBranchMarks;

      const NS="http://www.w3.org/2000/svg";
      const g=document.getElementById("stations");
      g.innerHTML="";

      function addStationOnMain(id, labelText){
        const t=mainMarks[id];
        const p=pointOnMain(t);
        const tan=tangentOnMain(t);
        const n={x:-tan.y, y:tan.x};

        const gx=document.createElementNS(NS,"g");
        gx.setAttribute("transform", `translate(${p.x.toFixed(2)},${p.y.toFixed(2)})`);

        const c=document.createElementNS(NS,"circle");
        c.setAttribute("r", id==="S" ? "11" : "10");
        c.setAttribute("fill","var(--panel)");
        c.setAttribute("stroke","var(--accent)");
        c.setAttribute("stroke-width","2");

        const text=document.createElementNS(NS,"text");
        const tx=(n.x*18 + tan.x*10);
        const ty=(n.y*18 + tan.y*10);
        text.setAttribute("x", tx.toFixed(2));
        text.setAttribute("y", ty.toFixed(2));
        text.setAttribute("fill","var(--text)");
        text.setAttribute("font-size","14");
        text.textContent = labelText;

        gx.appendChild(c);
        gx.appendChild(text);
        g.appendChild(gx);
      }

      function addStationOnBranch(id, labelText){
        const u=branchMarks[id];
        const p=pointOnBranch(u);
        const tan=tangentOnBranch(u);
        const n={x:-tan.y, y:tan.x};

        const gx=document.createElementNS(NS,"g");
        gx.setAttribute("transform", `translate(${p.x.toFixed(2)},${p.y.toFixed(2)})`);

        const c=document.createElementNS(NS,"circle");
        c.setAttribute("r","10");
        c.setAttribute("fill","var(--panel)");
        c.setAttribute("stroke","var(--accent)");
        c.setAttribute("stroke-width","2");

        const text=document.createElementNS(NS,"text");
        const tx=(n.x*18 + tan.x*10);
        const ty=(n.y*18 + tan.y*10);
        text.setAttribute("x", tx.toFixed(2));
        text.setAttribute("y", ty.toFixed(2));
        text.setAttribute("fill","var(--text)");
        text.setAttribute("font-size","14");
        text.textContent = labelText;

        gx.appendChild(c);
        gx.appendChild(text);
        g.appendChild(gx);
      }

      addStationOnMain("S",  "S 宿舍总站");
      addStationOnMain("T1", "T1 第一教学楼");
      addStationOnMain("T2", "T2 第二教学楼");
      addStationOnMain("T3", "T3 第三教学楼");
      addStationOnMain("C",  "C C楼");
      addStationOnMain("T4", "T4 第四教学楼");
      addStationOnMain("T5", "T5 第五教学楼");
      addStationOnBranch("T6", "T6 第六教学楼");
    }

    /* ===== 传送带渲染 & 状态 ===== */
    function placeOnMain(groupEl, vecEl, t){
      const p=pointOnMain(t);
      const tan=tangentOnMain(t);
      groupEl.setAttribute("transform", `translate(${p.x},${p.y}) rotate(${Math.atan2(tan.y,tan.x)*180/Math.PI})`);
      vecEl.setAttribute("x1", p.x); vecEl.setAttribute("y1", p.y);
      vecEl.setAttribute("x2", (p.x+tan.x*40).toFixed(2));
      vecEl.setAttribute("y2", (p.y+tan.y*40).toFixed(2));
    }
    function placeOnBranch(groupEl, vecEl, u){
      const p=pointOnBranch(u);
      const tan=tangentOnBranch(u);
      groupEl.setAttribute("transform", `translate(${p.x},${p.y}) rotate(${Math.atan2(tan.y,tan.x)*180/Math.PI})`);
      vecEl.setAttribute("x1", p.x); vecEl.setAttribute("y1", p.y);
      vecEl.setAttribute("x2", (p.x+tan.x*36).toFixed(2));
      vecEl.setAttribute("y2", (p.y+tan.y*36).toFixed(2));
    }

    function setStatusBadge(badgeEl,textEl,level){
      badgeEl.classList.remove("warn","bad");
      if(level==="warn") badgeEl.classList.add("warn");
      if(level==="bad") badgeEl.classList.add("bad");
      textEl.textContent = level==="ok"?"运行中":(level==="warn"?"注意":"故障");
    }
    function seatsAvail(B){ return Math.max(0, B.cap - B.pax); }

    function updateBeltCard(prefix,B){
      const dist=(B.mode==="main"?lenMain:lenBranch);
      const v=(B.mode==="main"?B.vMain:B.vBranch);
      const speed=(v*dist/(state.tickMs/1000));

      el(prefix+"Speed").textContent=speed.toFixed(1);
      el(prefix+"Pax").textContent=B.pax.toFixed(0);
      el(prefix+"Cap").textContent=B.cap.toFixed(0);
      el(prefix+"Seats").textContent=seatsAvail(B).toFixed(0);
      el(prefix+"Delay").textContent=B.delay.toFixed(0);
      el(prefix+"Next").textContent=stationLabel(B.next);

      setStatusBadge(el(prefix+"Status"), el(prefix+"StatusText"), B.status);
    }

    /* ===== 站点 ETA ===== */
    function penaltyNow(){
      return state.alarms>=3 ? 0.55 : (state.alarms>=1 ? 0.80 : 1.0);
    }
    function fmtEta(sec){
      if(!isFinite(sec) || sec<0) return "—";
      const s=Math.max(0, Math.ceil(sec));
      const m=Math.floor(s/60);
      const r=s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }
    function branchStepPerTick(B, pen){
      return B.vBranch*(lenMain/lenBranch)*pen;
    }
    function timeToReachMainFromMain(B, stationId, pen){
      const mt=mainMarks[stationId];
      const delta=(mt - B.t + 1) % 1;
      const step=B.vMain*pen;
      if(step<=1e-6) return Infinity;
      return delta/step*(state.tickMs/1000);
    }
    function timeToReachT2FromBranch(B, pen){
      const step=branchStepPerTick(B, pen);
      if(step<=1e-6) return Infinity;
      if(B.next==="T2"){
        const delta=Math.abs(B.u - branchMarks.T2);
        return delta/step*(state.tickMs/1000);
      }
      const toT6 = Math.abs(branchMarks.T6 - B.u)/step*(state.tickMs/1000);
      const backT2 = Math.abs(branchMarks.T6 - branchMarks.T2)/step*(state.tickMs/1000);
      return toT6 + backT2;
    }
    function timeToReachBranchStation(B, stationId, pen){
      const step=branchStepPerTick(B, pen);
      if(step<=1e-6) return Infinity;
      if(stationId==="T6"){
        if(B.next!=="T6") return Infinity;
        const delta=Math.abs(branchMarks.T6 - B.u);
        return delta/step*(state.tickMs/1000);
      }
      if(stationId==="T2"){
        if(B.next==="T2"){
          const delta=Math.abs(B.u - branchMarks.T2);
          return delta/step*(state.tickMs/1000);
        }else{
          const toT6 = Math.abs(branchMarks.T6 - B.u)/step*(state.tickMs/1000);
          const backT2 = Math.abs(branchMarks.T6 - branchMarks.T2)/step*(state.tickMs/1000);
          return toT6 + backT2;
        }
      }
      return Infinity;
    }

    function computeAndRenderETAs(){
      const pen = penaltyNow();
      const eta = {};
      for(const s of stations) eta[s.id]=Infinity;

      const belts = Object.values(state.belts);
      for(const B of belts){
        for(const s of stations){
          let tSec=Infinity;

          if(s.id==="T6"){
            if(B.mode==="branch") tSec = timeToReachBranchStation(B,"T6",pen);
          } else if(s.id==="T2"){
            if(B.mode==="main") tSec = timeToReachMainFromMain(B,"T2",pen);
            else tSec = timeToReachBranchStation(B,"T2",pen);
          } else {
            if(B.mode==="main"){
              tSec = timeToReachMainFromMain(B, s.id, pen);
            } else {
              const toT2 = timeToReachT2FromBranch(B, pen);
              const delta=(mainMarks[s.id] - mainMarks["T2"] + 1) % 1;
              const step=B.vMain*pen;
              const after = (step<=1e-6) ? Infinity : (delta/step*(state.tickMs/1000));
              tSec = toT2 + after;
            }
          }
          if(tSec < eta[s.id]) eta[s.id]=tSec;
        }
      }

      el("eta_S").textContent  = fmtEta(eta.S);
      el("eta_T1").textContent = fmtEta(eta.T1);
      el("eta_T2").textContent = fmtEta(eta.T2);
      el("eta_T3").textContent = fmtEta(eta.T3);
      el("eta_C").textContent  = fmtEta(eta.C);
      el("eta_T4").textContent = fmtEta(eta.T4);
      el("eta_T5").textContent = fmtEta(eta.T5);
      el("eta_T6").textContent = fmtEta(eta.T6);
    }

    function updateUI(){
      el("tickMs").textContent=state.tickMs;
      if(state.connected){
        connDot.classList.remove("off");
        connText.textContent=state.paused?"在线（已暂停）":"在线（仿真）";
      }else{
        connDot.classList.add("off");
        connText.textContent="离线";
      }

      updateBeltCard("b1", state.belts.B1);
      updateBeltCard("b2", state.belts.B2);
      updateBeltCard("b3", state.belts.B3);
      updateBeltCard("b4", state.belts.B4);

      el("alarms").textContent=state.alarms;
      const lineLevel = state.alarms===0?"ok":(state.alarms<=2?"warn":"bad");
      el("lineStatusText").textContent = lineLevel==="ok"?"良好":(lineLevel==="warn"?"有告警":"风险");
      el("lineStatus").classList.remove("warn","bad");
      if(lineLevel==="warn") el("lineStatus").classList.add("warn");
      if(lineLevel==="bad") el("lineStatus").classList.add("bad");

      computeAndRenderETAs();
      if(seatModalOpen) renderSeatModal();
    }

    /* ===== 预约分配逻辑 ===== */
    function assignReservation(req){
      const belts = Object.values(state.belts);
      const candidates = belts.filter(b => seatsAvail(b) >= req.seats);
      if(!candidates.length) return null;

      const needsBranch = (req.from==="T6" || req.to==="T6");
      function score(b){
        if(needsBranch){
          const tNow = (b.mode==="main"?b.t:mainMarks.T2);
          const d = Math.min(Math.abs(tNow-mainMarks.T2), 1-Math.abs(tNow-mainMarks.T2));
          return d;
        } else {
          const pickT = mainMarks[req.from] ?? mainMarks.S;
          const tNow = (b.mode==="main"?b.t:mainMarks.T2);
          const d = Math.min(Math.abs(tNow-pickT), 1-Math.abs(tNow-pickT));
          return d;
        }
      }
      candidates.sort((a,b)=>score(a)-score(b));
      return candidates[0].id;
    }

    /* ===== 到站/分流 ===== */
    let lastDock = { B1:null, B2:null, B3:null, B4:null };

    function dockMain(key, stationId){
      const B = state.belts[key];

      const off = Math.round(rand(0, Math.min(B.pax, 10)));
      const on  = Math.round(rand(0, 12));
      B.pax = clamp(B.pax - off + on, 0, B.cap);
      B.delay = clamp(B.delay + rand(-3, 6), 0, 90);

      if(state.reservations.length){
        const idx = state.reservations.findIndex(r => r.from===stationId && r.assignedTo===B.id);
        if(idx !== -1){
          const r = state.reservations.splice(idx, 1)[0];
          B.pax = clamp(B.pax + r.seats, 0, B.cap);
          addLog("预约确认上客", `${B.id} 在 ${stationLabel(r.from)} 上客 ${r.seats} 人，前往 ${stationLabel(r.to)}（剩余座位：${seatsAvail(B)}）`);

          if((r.from==="T6" || r.to==="T6") && stationId==="T2"){
            B.mode="branch";
            B.u=branchMarks.T2;
            B.next="T6";
            addLog("支线分流", `${B.id} 在 ${stationLabel("T2")} 分流进入支线，前往 ${stationLabel("T6")}`);
            return;
          }
        }
      }

      const pendingBranch = state.reservations.find(r => (r.from==="T6"||r.to==="T6") && r.assignedTo===B.id);
      if(pendingBranch && stationId==="T2"){
        B.mode="branch";
        B.u=branchMarks.T2;
        B.next="T6";
        addLog("支线分流", `${B.id} 在 ${stationLabel("T2")} 分流进入支线（存在到/来自T6的预约任务）`);
        return;
      }

      B.next = nextInMainLoop(stationId);
      addLog("到站", `${B.id} 抵达 ${stationLabel(stationId)}，下一站 ${stationLabel(B.next)}（剩余座位：${seatsAvail(B)}）`);
    }

    function dockBranch(key, stationId){
      const B=state.belts[key];

      if(stationId==="T6"){
        const off = Math.round(rand(0, Math.min(B.pax, 8)));
        const on  = Math.round(rand(0, 10));
        B.pax = clamp(B.pax - off + on, 0, B.cap);
        B.delay = clamp(B.delay + rand(-2, 5), 0, 90);
        addLog("到站（支线）", `${B.id} 抵达 ${stationLabel("T6")}，将返回 ${stationLabel("T2")}（剩余座位：${seatsAvail(B)}）`);
        B.next="T2";
        return;
      }

      if(stationId==="T2"){
        B.mode="main";
        B.t=mainMarks.T2;
        B.next=nextInMainLoop("T2");
        addLog("返回主环线", `${B.id} 已回到 ${stationLabel("T2")}，继续主环线至 ${stationLabel(B.next)}`);
      }
    }

    function maybeDock(key){
      const B=state.belts[key];
      if(B.mode==="main"){
        const near=nearestMainStationId(B.t);
        if(!isNearMainStation(B.t, near)) return;
        if(lastDock[key]===`main:${near}`) return;
        lastDock[key]=`main:${near}`;
        dockMain(key, near);
      }else{
        const near = isNearBranchStation(B.u,"T6") ? "T6" : (isNearBranchStation(B.u,"T2") ? "T2" : null);
        if(!near) return;
        if(lastDock[key]===`branch:${near}`) return;
        lastDock[key]=`branch:${near}`;
        dockBranch(key, near);
      }
    }

    /* ===== 摄像头：实时摄像头（放弃本地 mp4） ===== */
    const cameras = [
      { id:"CAM-01", where:"S 宿舍总站 · 上行平台", pos:"S站上行端", ai:"客流/跌倒检测" },
      { id:"CAM-02", where:"T1 第一教学楼 · 出入口", pos:"T1东侧", ai:"拥堵检测" },
      { id:"CAM-03", where:"T2 第二教学楼 · 分流点", pos:"T2分叉口", ai:"分流异常/逆行" },
      { id:"CAM-04", where:"T3 第三教学楼 · 站台", pos:"T3站台", ai:"客流统计" },
      { id:"CAM-05", where:"T4 第四教学楼 · 高架段", pos:"T4外环高架", ai:"障碍物检测" },
      { id:"CAM-06", where:"T5 第五教学楼 · 站台", pos:"T5站台", ai:"排队检测" },
      { id:"CAM-07", where:"T6 第六教学楼 · 支线端", pos:"T6支线端", ai:"人群聚集/异常停留" },
    ];

    const camSelect = el("camSelect");
    const camDeviceSelect = el("camDeviceSelect");
    const camList = el("camList");
    const camVideo = el("camVideo");
    const camErr = el("camErr");
    const camErrMsg = el("camErrMsg");
    const camSrcBadge = el("camSrcBadge");
    const btnCamStart = el("btnCamStart");
    const btnCamRetry = el("btnCamRetry");
    const btnCamStop = el("btnCamStop");

    let camRuntime = { fps:24, lag:80, online:false };
    let camStream = null;
    let camStarted = false;
    let activeDeviceId = "";

    function stopCamera(){
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
      camVideo.srcObject = null;
      camStarted = false;
      camRuntime.online = false;
      el("camDot").classList.add("off");
      el("camDev").textContent = "—";
    }

    async function ensureDevicesListed(){
      if(!navigator.mediaDevices?.enumerateDevices) {
        camDeviceSelect.innerHTML = `<option value="">默认设备</option>`;
        return;
      }
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d=>d.kind==="videoinput");
      camDeviceSelect.innerHTML = "";
      if(!vids.length){
        const opt=document.createElement("option");
        opt.value="";
        opt.textContent="未检测到摄像头设备";
        camDeviceSelect.appendChild(opt);
        return;
      }
      const opt0=document.createElement("option");
      opt0.value="";
      opt0.textContent="默认设备";
      camDeviceSelect.appendChild(opt0);

      vids.forEach((d, idx)=>{
        const opt=document.createElement("option");
        opt.value=d.deviceId;
        opt.textContent=d.label || `摄像头 ${idx+1}`;
        camDeviceSelect.appendChild(opt);
      });

      if(activeDeviceId){
        camDeviceSelect.value = activeDeviceId;
      }
    }

    async function startCamera(deviceId=""){
      camErr.style.display = "none";
      try{
        if(!navigator.mediaDevices?.getUserMedia){
          throw new Error("当前浏览器不支持 getUserMedia。");
        }

        stopCamera();
        activeDeviceId = deviceId || "";

        const constraints = {
          audio: false,
          video: deviceId
            ? { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }
            : { width: { ideal: 1280 }, height: { ideal: 720 } }
        };

        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        camVideo.srcObject = camStream;
        await camVideo.play();

        camStarted = true;
        camRuntime.online = true;
        el("camDot").classList.remove("off");
        camSrcBadge.textContent = "源：WebCamera";

        await ensureDevicesListed();
        const label = camDeviceSelect.selectedOptions?.[0]?.textContent || "默认设备";
        el("camDev").textContent = label;

        addLog("监控", `摄像头已开启（设备：${label}）`);
      } catch(err){
        camStarted = false;
        camRuntime.online = false;
        el("camDot").classList.add("off");
        camErr.style.display = "grid";
        camErrMsg.textContent = `打开摄像头失败：${err?.message || String(err)}。请允许权限或切换设备后重试。`;
        addLog("监控异常", `摄像头开启失败：${err?.message || String(err)}`);
      }
    }

    // FPS 估算：优先使用 requestVideoFrameCallback
    let fpsCounter = { frames:0, lastTs:0, fps:0 };
    function hookFps(){
      if(!camVideo) return;

      const hasRVFC = typeof camVideo.requestVideoFrameCallback === "function";
      if(hasRVFC){
        const onFrame = (now)=>{
          if(!fpsCounter.lastTs) fpsCounter.lastTs = now;
          fpsCounter.frames++;
          const dt = now - fpsCounter.lastTs;
          if(dt >= 1000){
            fpsCounter.fps = Math.round((fpsCounter.frames*1000)/dt);
            fpsCounter.frames = 0;
            fpsCounter.lastTs = now;
          }
          camVideo.requestVideoFrameCallback(onFrame);
        };
        camVideo.requestVideoFrameCallback(onFrame);
      }else{
        setInterval(()=>{
          // 无法精准统计时：维持一个平滑的“演示 FPS”
          fpsCounter.fps = Math.round(clamp((fpsCounter.fps||24) + rand(-2,2), 18, 30));
        }, 700);
      }
    }

    function updateCamHUD(){
      camRuntime.lag = Math.round(clamp(camRuntime.lag + rand(-20, 30), 40, 220));
      camRuntime.fps = fpsCounter.fps || camRuntime.fps;

      el("camFps").textContent = camStarted ? String(camRuntime.fps) : "—";
      el("camLag").textContent = camStarted ? String(camRuntime.lag) : "—";
      el("camTime").textContent = new Date().toLocaleString();

      el("camDot").classList.toggle("off", !camRuntime.online);
    }

    function renderCam(camId){
      const c = cameras.find(x=>x.id===camId) || cameras[0];
      el("camTitle").textContent = c.id;
      el("camWhere").textContent = c.where;
      el("camChan").textContent = c.id;
      el("camPos").textContent = c.pos;
      el("camAI").textContent = c.ai;

      addLog("监控调看", `切换至 ${c.id}（${c.where}）`);
      updateCamHUD();
    }

    async function initCams(){
      camSelect.innerHTML = "";
      cameras.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c.id;
        opt.textContent=`${c.id}｜${c.where}`;
        camSelect.appendChild(opt);
      });
      camSelect.value="CAM-01";
      camSelect.addEventListener("change", ()=>renderCam(camSelect.value));

      camDeviceSelect.addEventListener("change", ()=>{
        startCamera(camDeviceSelect.value);
      });

      camList.innerHTML="";
      cameras.forEach(c=>{
        const row=document.createElement("div");
        row.className="card";
        row.style.padding="10px";
        row.innerHTML=`
          <div class="row">
            <div style="font-weight:650;">${escapeHtml(c.id)}</div>
            <button class="ghost" data-cam="${escapeHtml(c.id)}">调看</button>
          </div>
          <div style="height:6px;"></div>
          <div class="row"><div class="k">位置</div><div class="v">${escapeHtml(c.where)}</div></div>
          <div class="row"><div class="k">AI</div><div class="v">${escapeHtml(c.ai)}</div></div>
        `;
        camList.appendChild(row);
        row.querySelector("button").addEventListener("click", ()=>{
          setActiveTab("cams");
          camSelect.value=c.id;
          renderCam(c.id);
        });
      });

      btnCamStart.addEventListener("click", ()=>startCamera(camDeviceSelect.value));
      btnCamRetry.addEventListener("click", ()=>startCamera(camDeviceSelect.value));
      btnCamStop.addEventListener("click", ()=>{ stopCamera(); camErr.style.display="none"; addLog("监控", "摄像头已停止"); });

      // 初始先列设备（没有权限时 label 可能为空；开启后会刷新）
      await ensureDevicesListed();

      renderCam("CAM-01");
      hookFps();
    }

    /* ===== Tick 仿真 ===== */
    function tick(){
      if(!state.connected || state.paused) return;

      if(Math.random()<0.03){
        state.alarms = clamp(state.alarms + (Math.random()<0.65?1:-1), 0, 5);
        if(state.alarms>0) addLog("线路告警", `检测到 ${state.alarms} 个告警（示例：风速/间距/供电波动）`);
      }
      const penalty = penaltyNow();

      for(const key of ["B1","B2","B3","B4"]){
        const B=state.belts[key];
        B.status = state.alarms>=4?"warn":"ok";
        if(Math.random()<0.004){
          B.status="bad";
          addLog("载具故障", `${B.id} 上报故障（示例：传感器/驱动），建议人工确认`);
        }

        if(B.mode==="main"){
          B.t = (B.t + B.vMain*penalty) % 1;
        }else{
          const dir = (B.next==="T6") ? +1 : -1;
          B.u = clamp(B.u + dir*branchStepPerTick(B, penalty), 0, 1);
        }

        if(key==="B1") (B.mode==="main") ? placeOnMain(belt1, vec1, B.t) : placeOnBranch(belt1, vec1, B.u);
        if(key==="B2") (B.mode==="main") ? placeOnMain(belt2, vec2, B.t) : placeOnBranch(belt2, vec2, B.u);
        if(key==="B3") (B.mode==="main") ? placeOnMain(belt3, vec3, B.t) : placeOnBranch(belt3, vec3, B.u);
        if(key==="B4") (B.mode==="main") ? placeOnMain(belt4, vec4, B.t) : placeOnBranch(belt4, vec4, B.u);

        maybeDock(key);
      }

      updateCamHUD();
      updateUI();
    }

    /* ===== 控制：暂停/主题/退出 ===== */
    btnPause.addEventListener("click", ()=>{
      state.paused=!state.paused;
      btnPause.textContent=state.paused?"恢复仿真":"暂停仿真";
      updateUI();
      addLog(state.paused?"仿真暂停":"仿真恢复", state.paused?"已暂停实时更新（演示）":"已恢复实时更新（演示）");
    });
    btnTheme.addEventListener("click", toggleTheme);
    btnLogout.addEventListener("click", ()=>{
      stopCamera();
      setLoggedIn(false);
      addLog("退出", "已退出系统");
    });

    /* ===== Tab 切换 ===== */
    function setActiveTab(tab){
      document.querySelectorAll(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      el("tabPanelOps").classList.toggle("hide", tab!=="ops");
      el("tabPanelCams").classList.toggle("hide", tab!=="cams");

      // 进入监控页：若尚未开启，提示用户可一键开启
      if(tab==="cams"){
        renderCam(camSelect.value || "CAM-01");
      }
    }
    document.querySelectorAll(".tabBtn").forEach(b=>b.addEventListener("click", ()=>setActiveTab(b.dataset.tab)));

    /* ===== 事件日志弹窗 ===== */
    const logModal = el("logModalBackdrop");
    const btnViewLog = el("btnViewLog");
    const btnLogClose = el("btnLogClose");
    const btnLogClose2 = el("btnLogClose2");
    function openLogModal(){ logModal.style.display="flex"; }
    function closeLogModal(){ logModal.style.display="none"; }
    btnViewLog.addEventListener("click", openLogModal);
    btnLogClose.addEventListener("click", closeLogModal);
    btnLogClose2.addEventListener("click", closeLogModal);
    logModal.addEventListener("click", (e)=>{ if(e.target===logModal) closeLogModal(); });

    /* ===== 座位预约弹窗 ===== */
    const modal = el("modalBackdrop");
    const btnReserve = el("btnReserve");
    const btnClose = el("btnClose");
    const btnCancel = el("btnCancel");
    const btnSubmit = el("btnSubmit");
    function openModal(){ modal.style.display="flex"; }
    function closeModal(){ modal.style.display="none"; }
    btnReserve.addEventListener("click", openModal);
    btnClose.addEventListener("click", closeModal);
    btnCancel.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

    function fillStationSelects(){
      const fromSel=el("fromStation");
      const toSel=el("toStation");
      fromSel.innerHTML=""; toSel.innerHTML="";
      for(const s of stations){
        const o1=document.createElement("option");
        o1.value=s.id; o1.textContent=`${s.id} ${s.name}`;
        fromSel.appendChild(o1);
        const o2=document.createElement("option");
        o2.value=s.id; o2.textContent=`${s.id} ${s.name}`;
        toSel.appendChild(o2);
      }
      fromSel.value="S";
      toSel.value="T3";
    }

    btnSubmit.addEventListener("click", ()=>{
      const from=el("fromStation").value;
      const to=el("toStation").value;
      const seats=parseInt(el("seatsNeed").value||"1",10);
      const priority=el("priority").value;
      const note=el("note").value.trim();

      if(from===to){
        addLog("预约失败","上车站点与目的站点不能相同");
        closeModal(); return;
      }

      const req={
        id: crypto.randomUUID?.() || String(Date.now()),
        from,to,
        seats: clamp(seats,1,20),
        priority, note,
        ts: Date.now(),
        assignedTo: null
      };

      const assigned=assignReservation(req);
      if(!assigned){
        addLog("预约失败", `当前无足够剩余座位可满足 ${req.seats} 个座位预约`);
        closeModal(); return;
      }
      req.assignedTo=assigned;
      state.reservations.push(req);
      addLog("预约已提交", `预约 ${req.seats} 座位：${stationLabel(from)} → ${stationLabel(to)}，已分配至 ${assigned}（优先级：${priorityLabel(priority)}）`);
      closeModal();
    });

    /* ===== 座位情况弹窗 ===== */
    const seatModal = el("seatModalBackdrop");
    const btnSeatStatus = el("btnSeatStatus");
    const btnSeatClose = el("btnSeatClose");
    const btnSeatClose2 = el("btnSeatClose2");
    const seatGrid = el("seatGrid");
    let seatModalOpen = false;

    function openSeatModal(){
      seatModalOpen = true;
      renderSeatModal();
      seatModal.style.display="flex";
    }
    function closeSeatModal(){
      seatModalOpen = false;
      seatModal.style.display="none";
    }
    btnSeatStatus.addEventListener("click", openSeatModal);
    btnSeatClose.addEventListener("click", closeSeatModal);
    btnSeatClose2.addEventListener("click", closeSeatModal);
    seatModal.addEventListener("click", (e)=>{ if(e.target===seatModal) closeSeatModal(); });

    function statusLabel(level){ return level==="ok"?"运行中":(level==="warn"?"注意":"故障"); }

    function renderSeatModal(){
      const belts = Object.values(state.belts);
      seatGrid.innerHTML = "";
      belts.forEach(B=>{
        const avail = seatsAvail(B);
        const occ = clamp((B.pax / Math.max(1,B.cap))*100, 0, 100);
        const item = document.createElement("div");
        item.className = "seatItem";
        item.innerHTML = `
          <div class="row">
            <div style="font-weight:650;">${escapeHtml(B.id)}</div>
            <span class="status ${B.status==="warn"?"warn":(B.status==="bad"?"bad":"")}" style="justify-self:end;">
              <span class="sDot"></span><span>${escapeHtml(statusLabel(B.status))}</span>
            </span>
          </div>
          <div class="row"><div class="k">模式</div><div class="v">${escapeHtml(B.mode==="main"?"主环线":"支线")}</div></div>
          <div class="row"><div class="k">载客 / 容量</div><div class="v">${B.pax.toFixed(0)} / ${B.cap.toFixed(0)}</div></div>
          <div class="row"><div class="k">剩余座位</div><div class="v">${avail.toFixed(0)}</div></div>
          <div class="row"><div class="k">占用率</div><div class="v">${occ.toFixed(1)}%</div></div>
          <div class="seatBar" aria-label="占用进度">
            <div class="seatFill" style="width:${occ.toFixed(1)}%"></div>
          </div>
        `;
        seatGrid.appendChild(item);
      });
    }

    /* ===== 点歌弹窗 ===== */
    const songModal = el("songModalBackdrop");
    const btnSong = el("btnSong");
    const btnSongClose = el("btnSongClose");
    const btnSongClose2 = el("btnSongClose2");
    const songListEl = el("songList");
    const musicAudio = el("musicAudio");
    const nowPlayingEl = el("nowPlaying");
    const btnMusicStop = el("btnMusicStop");
    const musicVol = el("musicVol");
    const musicErr = el("musicErr");

    const songs = [
      { id:"S1", title:"稻香", artist:"周杰伦", src:"music/song01.mp3", note:"music/ 下" },
      { id:"S2", title:"晴天", artist:"周杰伦", src:"music/song02.mp3", note:"music/ 下" },
      { id:"S3", title:"青花瓷", artist:"周杰伦", src:"music/song03.mp3", note:"music/ 下" },
    ];

    function openSongModal(){
      renderSongList();
      songModal.style.display="flex";
    }
    function closeSongModal(){
      songModal.style.display="none";
    }

    btnSong.addEventListener("click", openSongModal);
    btnSongClose.addEventListener("click", closeSongModal);
    btnSongClose2.addEventListener("click", closeSongModal);
    songModal.addEventListener("click", (e)=>{ if(e.target===songModal) closeSongModal(); });

    musicVol.addEventListener("input", ()=>{
      musicAudio.volume = parseFloat(musicVol.value);
    });
    btnMusicStop.addEventListener("click", ()=>{
      musicAudio.pause();
      musicAudio.currentTime = 0;
      nowPlayingEl.textContent = "—";
      musicErr.style.display = "none";
    });

    function setNowPlaying(text){
      nowPlayingEl.textContent = text;
    }

    function playSong(song){
      musicErr.style.display = "none";
      setNowPlaying(`${song.title} · ${song.artist}`);
      musicAudio.src = song.src;
      musicAudio.volume = parseFloat(musicVol.value);

      const p = musicAudio.play();
      if(p && typeof p.catch==="function"){
        p.catch(()=>{
          musicErr.style.display = "block";
          musicErr.textContent = `无法播放：${song.src}。请确认音频文件存在于同目录，或浏览器允许自动播放（可先手动点播放）。`;
        });
      }
      addLog("点歌", `播放：${song.title}（${song.src}）`);
    }

    function renderSongList(){
      songListEl.innerHTML = "";
      songs.forEach(s=>{
        const row=document.createElement("div");
        row.className="songRow";
        row.innerHTML = `
          <div class="songMeta">
            <div class="songTitle">${escapeHtml(s.title)}</div>
            <div class="songSub">${escapeHtml(s.artist)} · ${escapeHtml(s.note)}</div>
          </div>
          <div class="songActions">
            <button class="primary miniBtn" data-act="play">播放</button>
          </div>
        `;
        row.querySelector('button[data-act="play"]').addEventListener("click", ()=>playSong(s));
        songListEl.appendChild(row);
      });

      musicAudio.onended = ()=>{ setNowPlaying("—"); };
      musicAudio.onerror = ()=>{
        musicErr.style.display = "block";
        musicErr.textContent = `音频加载失败：${musicAudio.currentSrc || "未知源"}。请检查文件路径或格式。`;
      };
    }

    /* ===== 初始化 ===== */
    (function init(){
      let theme="dark";
      try { theme = localStorage.getItem("skyrail_theme") || "dark"; } catch {}
      applyTheme(theme);

      computeMarksAndRenderStations();
      fillStationSelects();
      initCams();

      state.belts.B1.next = nextInMainLoop(nearestMainStationId(state.belts.B1.t));
      state.belts.B2.next = nextInMainLoop(nearestMainStationId(state.belts.B2.t));
      state.belts.B3.next = nextInMainLoop(nearestMainStationId(state.belts.B3.t));
      state.belts.B4.next = nextInMainLoop(nearestMainStationId(state.belts.B4.t));

      placeOnMain(belt1, vec1, state.belts.B1.t);
      placeOnMain(belt2, vec2, state.belts.B2.t);
      placeOnMain(belt3, vec3, state.belts.B3.t);
      placeOnMain(belt4, vec4, state.belts.B4.t);

      addLog("系统启动", "控制台已就绪（本地仿真数据 + 监控使用浏览器实时摄像头）。");
      updateUI();

      setInterval(tick, state.tickMs);
      setLoggedIn(false);
    })();
  </script>
</body>
</html>
